<script>
    // ##############  OCCLUSION SHORTCUTS  ##############
    // Visit https://keycode.info/ to get the number/letter for the key you want to assign. 
    var RevealIncremental = "78"; // n
    var ToggleAllOcclusions = "188"; // ,

    // ##############  TAG SHORTCUT  ##############
    // Visit https://keycode.info/ to get the number/letter for the key you want to assign. 
    var ToggleTags = "67"; // c

    // ##############  BUTTON SETTINGS  ##############
    // The button shortcuts are  Alt + the number/letter the keycode stands for
    // All buttons will also open with "H" if using the Hint Hotkeys add-on 
    // Visit https://keycode.info/ to get the number/letter for the key you want to assign. 
    var Extra = '49'; // alt + 1
    var PersonalNotes = '50'; // alt + 2
    var MissedQ = '51'; // alt + 3
    var ToggleAllButtons = '222'; // '

    var ScrollToButton = true;

    // change values from false to true to have the fields revealed from the start
    var ShowExtra = false;
    var ShowPersonalNotes = false;
    var ShowMissedQuestions = false;

    //ENTER THE TAG TERM WHICH, WHEN PRESENT, WILL TRIGGER A RED BACKGROUND
    var tagID = "XXXYYYZZZ"
</script>


<div id="extras" hidden>{{I0}}</div>
<div class="header">{{Header}}</div>
<button class="dummy-btn"><div class="io">{{Image}}</div></button>
<br>
<button id="button-reveal-next" class="button-general">Reveal Next</button>
<button id="button-toggle-all" class="button-general">Toggle All</button>
<br>
<div class="btn-spacer" hidden></div>

<!-- EXTRA FIELD -->
{{#Extra}}
<a id="link-ex" href="#" class="hint" onclick="toggleHint('button-ex', 'hint-ex', 'link-ex')"></a>
<button id="button-ex" class="button-general" onclick="toggleHint('button-ex', 'hint-ex', 'link-ex')">
    <img src="_Anking_v3.png">
    Extra
</button>
<div id="hint-ex" style="display:none;">
    <div class="hints" id="extra">{{edit:Extra}}</div>
</div>
{{/Extra}}


<!-- PERSONAL NOTES FIELD -->
{{#Personal Notes}} 
<a id="link-ln" href="#" class="hint" onclick="toggleHint('button-ln', 'hint-ln', 'link-ln')"></a>
<button id="button-ln" class="button-general" onclick="toggleHint('button-ln', 'hint-ln', 'link-ln')" >
    <img src="_Anking_v3.png">
    Personal Notes
</button>
<div id="hint-ln" style="display:none;">
    <div class="hints" id="personal-notes">{{edit:Personal Notes}}</div>
</div>
{{/Personal Notes}}


<!-- MISSED QUESTIONS FIELD -->
{{#Missed Questions}}
<a id="link-mq" href="#" class="hint" onclick="toggleHint('button-mq', 'hint-mq', 'link-mq')"></a>
<button id="button-mq" class="button-general" onclick="toggleHint('button-mq', 'hint-mq', 'link-mq')">
    <img src="_Anking_v3.png">
    Missed Questions
</button>
<div id="hint-mq" style="display:none;">
    <div class="hints" id="missed-questions">{{edit:Missed Questions}}</div>
</div>
{{/Missed Questions}}


<a class="logo" href="https://www.ankingmed.com">
    <img src="_AnKingRound.png" alt="The AnKing">
</a>

<div id="anki-am" data-name="Assets by ASSET MANAGER" data-version="2.1">

    {{#Tags}}
    <div id="tags-container">{{clickable::Tags}}</div>
    <script>
        var tagContainer = document.getElementById("tags-container")
        if (tagContainer.childElementCount == 0) {
            var tagList = tagContainer.innerHTML.split(" ");
            var kbdList = [];
            var newTagContent = document.createElement("div");

            for (var i = 0; i < tagList.length; i++) {
                var newTag = document.createElement("kbd");
                newTag.innerHTML = tagList[i];
                newTagContent.append(newTag)
            }
            tagContainer.innerHTML = newTagContent.innerHTML;
            tagContainer.style.cursor = "default";
        }
        if (tagContainer.innerHTML.indexOf(tagID) != -1) {
            tagContainer.style.backgroundColor = "rgba(251,11,11,.15)";
        }

        function toggleTags() {
            var tags = document.getElementById("tags-container");
            if (!tags) return
            if (tags.style.display === "none") {
                tags.style.display = "block";
            } else {
                tags.style.display = "none";
            }
        }
        if (!globalThis.ToggleTagsListening) {
            globalThis.ToggleTagsListening = true
            document.addEventListener('keydown', function (evt) {
                if (evt.repeat) return
                evt = evt || window.event
                if (evt.keyCode == ToggleTags) {
                    toggleTags();
                }
            });
        }
    </script>
    {{/Tags}}

    <script>
        //HINT REVEALS
        function toggleHint(btn_id, hint_id, link_id) {
            var button = document.getElementById(btn_id)
            var hint = document.getElementById(hint_id)
            var link = document.getElementById(link_id)
            if (!button) return
            if (hint.style.display == "none") {
                button.classList.add("expanded-button")
                hint.style.display = "block"
                link.style.display = "none"
                if (ScrollToButton) {
                    hint.scrollIntoView({
                        behavior: "smooth", // "auto" for instant scrolling
                        block: "start",
                        inline: "nearest"
                    });
                }
            } else {
                button.classList.remove("expanded-button")
                hint.style.display = "none"
                link.style.display = ""
            }
        }
        
        if(ShowExtra) toggleHint('button-ex', 'hint-ex', 'link-ex')
        if(ShowPersonalNotes) toggleHint('button-ln', 'hint-ln', 'link-ln')
        if(ShowMissedQuestions) toggleHint('button-mq', 'hint-mq', 'link-mq')

        if (!globalThis.ToggleHintsListening) {
            globalThis.ToggleHintsListening = true
            document.addEventListener("keydown", (evt) => {
                if (evt.repeat) return
                if (evt.altKey && evt.keyCode == PersonalNotes) {
                    toggleHint('button-ln', 'hint-ln', 'link-ln')
                }
                if (evt.altKey && evt.keyCode == MissedQ) {
                    toggleHint('button-mq', 'hint-mq', 'link-mq')
                }
                if (evt.altKey && evt.keyCode == Extra) {
                    toggleHint('button-ex', 'hint-ex', 'link-ex')
                }
                if (evt.keyCode == ToggleAllButtons) {
                    try { toggleHint('button-mq', 'hint-mq', 'link-mq'); }
                    finally {
                        try { toggleHint('button-ln', 'hint-ln', 'link-ln'); }
                        finally { toggleHint('button-ex', 'hint-ex', 'link-ex'); }
                    }
                }
                return false
            })
        }
    </script>


    <script data-name="Incremental IO" data-version="v0.1">
        /* Script by Matthias Metelka @kleinerpirat */

        function setupIncrementalIO() {
            var observer = new MutationObserver(() => {
                document.getElementById("button-toggle-all").addEventListener("click", toggleAll)
                document.getElementById("button-reveal-next").addEventListener("click", toggleNext)

                let rect = document.querySelector(".closet-rect.is-active")
                if (rect) {
                    activate(rect)
                    observer.disconnect()
                    globalThis.AnkingIORects = document.querySelectorAll(".closet-rect.is-active")
                    for (let rect of globalThis.AnkingIORects) {
                        rect.addEventListener("click", reveal)
                    }
                    if (!globalThis.AnKingIOListening) {
                        document.addEventListener("keydown", (evt) => {
                            if (evt.repeat) return
                            evt = evt || window.event
                            if (evt.keyCode == RevealIncremental) {
                                toggleNext()
                            }
                            else if (evt.keyCode == ToggleAllOcclusions) {
                                toggleAll()
                            }
                        })
                        globalThis.AnKingIOListening = true
                    }

                    let buttons = document.getElementsByClassName("extra-btn")
                    function toggle() {
                        if (!this.classList.contains("uncollapsed")) {
                            this.nextElementSibling.classList.remove("hidden")
                            this.classList.add("uncollapsed")
                        }
                        else {
                            this.nextElementSibling.classList.add("hidden")
                            this.classList.remove("uncollapsed")
                        }
                    }
                    for (let button of buttons) {
                        button.addEventListener("click", toggle)
                    }

                }
            })
            observer.observe(document.getElementById("qa"), {
                childList: true,
                subtree: true
            })


            function toggleNext() {
                let active = document.querySelector(".closet-rect.is-highlighted")
                if (active) incrementalReveal.call(active)
            }

            function toggleAll() {
                let allRevealed = true
                for (let rect of globalThis.AnkingIORects) {
                    if (!rect.classList.contains("revealed")) allRevealed = false
                }
                if (allRevealed) {
                    for (let rect of globalThis.AnkingIORects) {
                        hide.call(rect)
                    }
                    let newActiveRect = document.querySelector(".closet-rect.is-active")
                    activate(newActiveRect)
                } else {
                    for (let rect of globalThis.AnkingIORects) {
                        reveal.call(rect)
                    }
                }
            }

            function incrementalReveal() {
                reveal.call(this)
                let next = this.nextElementSibling
                if (next) {
                    while (next.classList.contains("revealed") && next.nextElementSibling) {
                        next = next.nextElementSibling
                    }
                    if (!next.classList.contains("revealed")) activate(next)
                }
                else if (document.getElementById("extra-content")) {
                    document.getElementById("extra-content").classList.remove("hidden")
                }
            }

            function reveal() {
                this.classList.remove("is-highlighted")
                this.classList.add("revealed")
            }

            function hide() {
                this.classList.remove("revealed")
                this.removeEventListener("click", incrementalReveal)
            }

            function activate(rect) {
                rect.classList.add("is-highlighted")
                rect.addEventListener("click", incrementalReveal)
            }

        }
        setupIncrementalIO()

    </script>

    <script data-name="Closet Setup" data-version="v0.1">
        function closetUserLogic(closet, preset, chooseMemory) {
            const elements = closet.template.anki.getQaChildNodes();
            const memory = chooseMemory("closet__1");
            const filterManager = closet.FilterManager.make(preset, memory.map);

            const output = [[elements, memory, filterManager]];

            filterManager.install(
                closet.recipes.shuffle({ tagname: "mix" }),
                closet.recipes.order({ tagname: "ord" }),

                closet.flashcard.recipes.cloze({
                    tagname: "c",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),
                closet.flashcard.recipes.multipleChoice({
                    tagname: "mc",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),
                closet.flashcard.recipes.sort({
                    tagname: "sort",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),
                closet.browser.recipes.rect({
                    tagname: "rect",
                    defaultBehavior: closet.flashcard.behaviors.Hide,
                }),
            );;
            return output;
        }

        var getAnkiPrefix = () =>
            globalThis.ankiPlatform === "desktop"
                ? ""
                : globalThis.AnkiDroidJS
                    ? "https://appassets.androidplatform.net"
                    : ".";

        var closetPromise = import(`${getAnkiPrefix()}/__closet-0.5.3.js`);
        closetPromise
            .then(
                ({ closet }) =>
                    closet.template.anki.initialize(
                        closet,
                        closetUserLogic,
                        "{{Card}}",
                        "{{Tags}}",
                        "back",
                    ),
                (error) => console.log("An error occured while loading Closet:", error),
            )
            .catch((error) =>
                console.log("An error occured while executing Closet:", error),
            );

        if (globalThis.onUpdateHook) {
            onUpdateHook.push(() => closetPromise);
        }
    </script>
</div>

<!-- WIKIPEDIA SEARCHES -->
<div id="popup-container">
    <button id="close-popup-btn" onclick="closePopup(true)">&times;</button>
    <a id="open-wiki-btn" href="">&#8618;</a>
    <div id="tc"></div> <div id="fadebottom_v"></div>
    <div id="ic"><img id="popup-image"></div>
  </div>
<style>
#tc {
color: #222222;
position:absolute;
top: 16px;
margin:0px;
left:15px;
text-decoration: none;
height:320px;
overflow:hidden;
overflow-y:scroll;
white-space:pre-wrap;
width: 300px;
}
#tc p{
margin:0px;
}
#tc::-webkit-scrollbar{
display:none;
} 
#fadebottom_v {
height: 30px;
width: 300px;
background: -webkit-linear-gradient(270deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 1));
z-index: 111;
position:absolute;
bottom:0px;
left:15px;
}
#hc{
color: #666;  
font-weight: bold;
}
#ic {
right:0px;
top:30px;
position:absolute;
}
#ic img{
width: 160px;
height:auto;
object-fit: cover;
overflow:hidden;
}
#popup-image {
width: 140px;
height: auto;
}
#popup-container {
background: #fff;
position: absolute;
bottom:30px;
right:10px;
z-index: 110;
-webkit-box-shadow: 0 30px 90px -20px rgba(0, 0, 0, 0.3), 0 0 1px 1px rgba(0, 0, 0, 0.05);
box-shadow: 0 30px 90px -20px rgba(0, 0, 0, 0.3), 0 0 1px 1px rgba(0, 0, 0, 0.05);
padding: 0;
display: none;
font-size: 17px;
line-height: 20px;
border-radius: 2px;
width: 480px;
height:340px;
overflow:hidden;
font-family: Arial;
text-align:left;
border: 1px solid #d0d0d0;
border-radius: 5px;
}
#close-popup-btn{
position:absolute;
top: 1px;
right:5px;
width: 32px;
height: 32px;
background: none;
border: 0;
cursor: pointer;
font-family: 'Josefin Sans', sans-serif;
font-size: 20px;
outline: none;
text-align:right;
z-index:112;
}
#open-wiki-btn{
position:absolute;
top: 10px;
right:30px;
width: 15px;
height: 32px;
background: none;
border: 0;
cursor: pointer;
text-decoration: none;
color:#222222;
font-family: 'Josefin Sans', sans-serif;
font-size: 17px;
outline: none;
text-align: left;
z-index:112;
}
</style>

<script>
    function getSummaryFor(word) {
      word = word.replace(/^[\.,\/#\!$%\^&\*;:{}=\-_`~()\'\s]+|[\.,\/#\!$%\^&\*;:{}=\-_`~()\'\s]+$/g, "");
           var pc = document.getElementById("popup-container");
         var hc = document.getElementById("hc");
          var tc = document.getElementById("tc");
          var ic = document.getElementById("ic");
          var imgelem = document.getElementById("popup-image");
             imgelem.src = "";
          var shortsum ="";
      fetch("https://en.wikipedia.org/api/rest_v1/page/summary/" + word).then(function(response) {return response.json();}).then(function(response) {
         shortsum = response.description;
       shortsum = shortsum.replace(/(Disambiguation.*)/g, "Disambiguation");
          tc.innerHTML = "<span id='hc'>" +capfl(shortsum) + "</span>" +"\n" +response.extract_html + "\n";
      tc.style.width = "420px";
          if (response.extract_html && !response.extract.endsWith("to:")){
              pc.style.display = "block";
          document.getElementById("open-wiki-btn").href = response.content_urls.desktop.page;
          }else{pc.style.display = "none";}
          if (!response.thumbnail.source || response.type ==="disambiguation"){
               tc.style.width = "420px";
          }else{tc.style.width="300px";imgelem.src = response.thumbnail.source;}
        }).catch(function(error) {console.log(error);});}

function closePopup(deselectAlso=false){
pcc.style.display = 'none';
if (deselectAlso){clearSelection();}
}
var pcc = document.getElementById("popup-container");
var prevSel = "";
document.addEventListener('click', function() {
  var currentSelection = getSelectionText();
  if (currentSelection !==""){prevSel = currentSelection;}
  if (currentSelection && !mustClickW ){
      getSummaryFor(currentSelection);
   }else{closePopup();}
});
document.addEventListener('keyup', function(e) {
  if(e.key =="w"){
  if(pcc.style.display ==="block"){closePopup();}else{getSummaryFor(prevSel);}
  }
});
function getSelectionText() {
  var text = "";
  if (window.getSelection) {
      text = window.getSelection().toString();
  } else if (document.selection && document.selection.type != "Control") { text = document.selection.createRange().text;}
  return text;
}
function capfl(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}
function clearSelection(){
if (window.getSelection) {window.getSelection().removeAllRanges();}
else if (document.selection) {document.selection.empty();}
}

//CUSTOMIZATION
//this is a variable controlling whether user must click the "w" key to open the popup.
//if set to true: user must select text, then click the "w" key to open wikipedia popup. Clicking "w" key again will close the popup. 
//if set to false: user only needs to select text. popup will open automatically. Clicking "w" is an alternative but not obligatory way of opening/closing the popup in this mode.
//BELOW SET to true or to false. 
var mustClickW = true;
//END CUSTOMIZATION
  </script>