<script>
    // ##############  HINT REVEAL SHORTCUTS  ##############
   //The following two shortcuts are with letters.
    var reveal_incremental = "n";
    var reveal_all = "c";
    var showhidetags = "]";

    // Visit https://keycode.info/ to get the number/letter for the key you want to assign. 
    // The button shortcuts are  Alt  +  the number/letter below
    // All buttons will also open with "H" if using the Hint Hotkeys add-on 
    var extra = '49';
    var personalnotes = '50';
    var missedQ = '51';
    var OpenCloseAll = '222';

	var ScrollToHint = true;

    //ENTER THE TAG TERM WHICH, WHEN PRESENT, WILL TRIGGER A RED BACKGROUND
    var tagID = "XXXYYYZZZ"
</script>


<div id="extras" hidden>{{I0}}</div>

<div class="header">{{Header}}</div>
<div class="io">{{Image}}</div>

<!-- EXTRA FIELD -->
{{#Extra}}<a href="#" class="hint" id="hint-ar" onclick="this.style.display='none'; RevealButton('button-ar', 'hint-ar', 'button-ar'); return false;">
    <button class="button-ar"><img src="_Anking_v3.png"> Extra</button></a>{{/Extra}}

<div id="button-ar" class="generalclass" style="display:none;">
{{#Extra}}<button onclick="document.getElementById('hint-ar').style.display='inline-block'; RevealButton('button-ar', 'hint-ar', 'button-ar')" class="button-ar button-revealed"><img src="_Anking_v3.png"> Extra</button>
    <br>
    <div class="hints" id="additional">{{edit:Extra}}</div>
{{/Extra}}</div>

<!-- PERSONAL NOTES FIELD -->
{{#Personal Notes}}<a href="#" class="hint" id="hint-ln" onclick="this.style.display='none'; RevealButton('button-ln', 'hint-ln', 'button-ln'); return false;">
        <button class="button-ln"><img src="_Anking_v3.png"> Personal Notes</button></a>{{/Personal Notes}}

<div id="button-ln" class="generalclass" style="display:none;">
    {{#Personal Notes}}<button onclick="document.getElementById('hint-ln').style.display='inline-block'; RevealButton('button-ln', 'hint-ln', 'button-ln')" class="button-ln button-revealed"><img src="_Anking_v3.png"> Personal Notes</button>
        <br>
        <div class="hints" id="lecture">{{edit:Personal Notes}}</div>
    {{/Personal Notes}}</div>

<!-- MISSED QUESTIONS FIELD -->
{{#Missed Questions}}<a href="#" class="hint" id="hint-mq" onclick="this.style.display='none'; RevealButton('button-mq', 'hint-mq', 'button-mq'); return false;">
        <button class="button-mq"><img src="_Anking_v3.png"> Missed Questions</button></a>{{/Missed Questions}}

<div id="button-mq" class="generalclass" style="display:none;">
    {{#Missed Questions}}<button onclick="document.getElementById('hint-mq').style.display='inline-block'; RevealButton('button-mq', 'hint-mq', 'button-mq')" class="button-mq button-revealed"><img src="_Anking_v3.png"> Missed Questions</button>
        <br>
        <div class="hints" id="missed">{{edit:Missed Questions}}</div>
    {{/Missed Questions}}</div>




</div>

<a class="logo" href="https://www.ankingmed.com">
   <img src="_AnKingRound.png" alt="The AnKing">
</a>

<div id="anki-am" data-name="Assets by ASSET MANAGER" data-version="2.1">

{{#Tags}}
    <div id="tags-container">{{clickable::Tags}}</div>
    <script>
        var tagContainer = document.getElementById("tags-container")
        if (tagContainer.childElementCount == 0) {
         var tagList= tagContainer.innerHTML.split(" ");
         var kbdList = [];
         var newTagContent = document.createElement("div");
        
         for (var i = 0; i < tagList.length;  i++) {
          var newTag = document.createElement("kbd");
          newTag.innerHTML = tagList[i];
          newTagContent.append(newTag)
         }
         tagContainer.innerHTML = newTagContent.innerHTML;
         tagContainer.style.cursor = "default";
        }
        if (tagContainer.innerHTML.indexOf(tagID) != -1) {
        tagContainer.style.backgroundColor = "rgba(251,11,11,.15)";
        }
        
        function showtags() {
          var tagContainerShortcut = document.getElementById("tags-container");
        
            if (tagContainerShortcut.style.display 
        === "none") {
            tagContainerShortcut.style.display = "block";
          } else {
            tagContainerShortcut.style.display = 
          "none";
          }
        } 
        document.addEventListener('keyup', function(e) {
            if(e.key == showhidetags){
             showtags();
            }
        });
        
        
    </script>
{{/Tags}}

<script>
    //HINT REVEALS
    function RevealButton(divid, id, divid) {
    var x = document.getElementById(divid), y = document.getElementById(id), z = document.getElementById(divid);
    if (x.style.display == "none")
    {
    x.style.display = "block"; y.style.display = "none"; z.scrollToId;
    }
        else {
          x.style.display = "none"; y.style.display = "inline-block";
        }
    if (ScrollToHint){
	z.scrollIntoView({
      behavior: "smooth", //"auto" for instant scrolling
      block: "start",
      inline: "nearest"
    }); }
      }
      document.onkeydown = function(evt) {
       evt = evt || window.event;
          if (evt.altKey && evt.keyCode == personalnotes) {
              RevealButton('button-ln', 'hint-ln', 'button-ln')}  
          if (evt.altKey && evt.keyCode == missedQ) {
              RevealButton('button-mq', 'hint-mq', 'button-mq')}
          if (evt.altKey && evt.keyCode == extra) {
              RevealButton('button-ar', 'hint-ar', 'button-ar')}
      
          if (evt.keyCode == OpenCloseAll) {
          try{RevealButton('button-mq', 'hint-mq', 'button-mq');}
          finally{try{RevealButton('button-ln', 'hint-ln', 'button-ln');}
          finally{RevealButton('button-ar', 'hint-ar', 'button-ar');}}
          }
      }
</script>



    <script data-name="Incremental IO" data-version="v0.1">
        /* Script by Matthias Metelka @kleinerpirat */

        (function () {
            var observer = new MutationObserver(() => {
                let rect = document.querySelector(".closet-rect.is-active")
                if (rect) {
                    activate(rect)
                    observer.disconnect()
                    let rects = document.querySelectorAll(".closet-rect.is-active")
                    for (let rect of rects) {
                        rect.addEventListener("click", reveal)
                        rect.addEventListener("touchstart", reveal)
                    }
                    if (!globalThis.AnKingIOListening) {
                        document.addEventListener("keydown", (event) => {
                            if (event.key == reveal_incremental) {
                                let active = document.querySelector(".closet-rect.is-highlighted")
                                if (active) incrementalReveal.call(active)
                            }
                            else if (event.key ==  reveal_all) {
                                for (let rect of rects) {
                                    incrementalReveal.call(rect)
                                }
                            }
                        })
                        globalThis.AnKingIOListening = true
                    }
                    let buttons = document.getElementsByClassName("extra-btn")

                    function toggle() {
                        if (!this.classList.contains("uncollapsed")) {
                            this.nextElementSibling.classList.remove("hidden")
                            this.classList.add("uncollapsed")
                        }
                        else {
                            this.nextElementSibling.classList.add("hidden")
                            this.classList.remove("uncollapsed")
                        }
                    }
                    for (let button of buttons) {
                        button.addEventListener("click", toggle)
                        button.addEventListener("touchstart", toggle)
                    }
                }
            })
            observer.observe(document.getElementById("qa"), {
                childList: true,
                subtree: true
            })

            function activate(rect) {
                rect.classList.add("is-highlighted")
                rect.addEventListener("click", incrementalReveal)
                rect.addEventListener("touchstart", incrementalReveal)
            }

            function incrementalReveal() {
                reveal.call(this)
                let next = this.nextElementSibling
                if (next) {
                    while (next.classList.contains("revealed") && next.nextElementSibling) {
                        next = next.nextElementSibling
                    }
                    if (!next.classList.contains("revealed")) activate(next)
                }
                else {
                    document.getElementById("extra-content").classList.remove("hidden")
                }
            }

            function reveal() {
                this.classList.remove("is-highlighted")
                this.classList.add("revealed")
            }
        })()
    </script>
    <script data-name="Closet Setup" data-version="v0.1">
        function closetUserLogic(closet, preset, chooseMemory) {
                const elements = closet.template.anki.getQaChildNodes();
            const memory = chooseMemory("closet__1");
            const filterManager = closet.FilterManager.make(preset, memory.map);

            const output = [[elements, memory, filterManager]];


            filterManager.install(
                closet.recipes.shuffle({ tagname: "mix" }),
                closet.recipes.order({ tagname: "ord" }),

                closet.flashcard.recipes.cloze({
                    tagname: "c",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),
                closet.flashcard.recipes.multipleChoice({
                    tagname: "mc",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),
                closet.flashcard.recipes.sort({
                    tagname: "sort",
                    defaultBehavior: closet.flashcard.behaviors.Show,
                }),

                closet.browser.recipes.rect({
                    tagname: "rect",
                    defaultBehavior: closet.flashcard.behaviors.Hide,
                }),
            );;
            return output;
        }

        var getAnkiPrefix = () =>
            globalThis.ankiPlatform === "desktop"
                ? ""
                : globalThis.AnkiDroidJS
                ? "https://appassets.androidplatform.net"
                : ".";

        var closetPromise = import(`${getAnkiPrefix()}/__closet-0.5.3.js`);
        closetPromise
            .then(
                ({ closet }) =>
                    closet.template.anki.initialize(
                        closet,
                        closetUserLogic,
                        "{{Card}}",
                        "{{Tags}}",
                        "back",
                    ),
                (error) => console.log("An error occured while loading Closet:", error),
            )
            .catch((error) =>
                console.log("An error occured while executing Closet:", error),
            );

        if (globalThis.onUpdateHook) {
            onUpdateHook.push(() => closetPromise);
        }
    </script>
</div>

